import { db } from "../db";
import { users, projects, services, testimonials, siteSettings } from "@shared/schema";
import { 
  seedUsers, 
  seedProjects, 
  seedServices, 
  seedTestimonials, 
  seedSiteSettings,
  generateHashedPasswords 
} from "./seedData";
import { sql, count } from "drizzle-orm";

export async function runCompleteMigration() {
  console.log("üöÄ Iniciando migra√ß√£o completa do banco de dados...");

  try {
    // Verificar se j√° existem dados nas tabelas principais
    const [userCount] = await db.select({ count: count() }).from(users);
    const [projectCount] = await db.select({ count: count() }).from(projects);
    const [serviceCount] = await db.select({ count: count() }).from(services);
    const [testimonialCount] = await db.select({ count: count() }).from(testimonials);
    const [settingsCount] = await db.select({ count: count() }).from(siteSettings);

    console.log("üìä Status atual das tabelas:");
    console.log(`- Usu√°rios: ${userCount.count}`);
    console.log(`- Projetos: ${projectCount.count}`);
    console.log(`- Servi√ßos: ${serviceCount.count}`);
    console.log(`- Depoimentos: ${testimonialCount.count}`);
    console.log(`- Configura√ß√µes: ${settingsCount.count}`);

    // 1. Criar usu√°rios (se n√£o existirem)
    if (userCount.count === 0) {
      console.log("üë§ Criando usu√°rios padr√£o...");
      const usersWithHashedPasswords = await generateHashedPasswords();
      
      for (const user of usersWithHashedPasswords) {
        await db.insert(users).values(user);
        console.log(`   ‚úì Usu√°rio criado: ${user.name} (${user.role})`);
      }
    } else {
      console.log("üë§ Usu√°rios j√° existem, pulando cria√ß√£o...");
    }

    // 2. Criar configura√ß√µes do site (se n√£o existirem)
    if (settingsCount.count === 0) {
      console.log("‚öôÔ∏è Criando configura√ß√µes do site...");
      await db.insert(siteSettings).values(seedSiteSettings);
      console.log("   ‚úì Configura√ß√µes do site criadas");
    } else {
      console.log("‚öôÔ∏è Configura√ß√µes do site j√° existem, pulando cria√ß√£o...");
    }

    // 3. Criar servi√ßos (se n√£o existirem)
    if (serviceCount.count === 0) {
      console.log("üõ†Ô∏è Criando servi√ßos...");
      for (const service of seedServices) {
        await db.insert(services).values(service);
        console.log(`   ‚úì Servi√ßo criado: ${service.title} - R$ ${service.price}`);
      }
    } else {
      console.log("üõ†Ô∏è Servi√ßos j√° existem, pulando cria√ß√£o...");
    }

    // 4. Criar projetos (se n√£o existirem)
    if (projectCount.count === 0) {
      console.log("üìÅ Criando projetos...");
      for (const project of seedProjects) {
        await db.insert(projects).values(project);
        console.log(`   ‚úì Projeto criado: ${project.title} (${project.category})`);
      }
    } else {
      console.log("üìÅ Projetos j√° existem, pulando cria√ß√£o...");
    }

    // 5. Criar depoimentos (se n√£o existirem)
    if (testimonialCount.count === 0) {
      console.log("üí¨ Criando depoimentos...");
      for (const testimonial of seedTestimonials) {
        await db.insert(testimonials).values(testimonial);
        console.log(`   ‚úì Depoimento criado: ${testimonial.name} - ${testimonial.company}`);
      }
    } else {
      console.log("üí¨ Depoimentos j√° existem, pulando cria√ß√£o...");
    }

    // Verificar status final
    const [finalUserCount] = await db.select({ count: count() }).from(users);
    const [finalProjectCount] = await db.select({ count: count() }).from(projects);
    const [finalServiceCount] = await db.select({ count: count() }).from(services);
    const [finalTestimonialCount] = await db.select({ count: count() }).from(testimonials);
    const [finalSettingsCount] = await db.select({ count: count() }).from(siteSettings);

    console.log("\nüìà Status final das tabelas:");
    console.log(`- Usu√°rios: ${finalUserCount.count}`);
    console.log(`- Projetos: ${finalProjectCount.count}`);
    console.log(`- Servi√ßos: ${finalServiceCount.count}`);
    console.log(`- Depoimentos: ${finalTestimonialCount.count}`);
    console.log(`- Configura√ß√µes: ${finalSettingsCount.count}`);

    console.log("\n‚úÖ Migra√ß√£o completa finalizada com sucesso!");
    
    return {
      success: true,
      message: "Migra√ß√£o executada com sucesso",
      stats: {
        users: finalUserCount.count,
        projects: finalProjectCount.count,
        services: finalServiceCount.count,
        testimonials: finalTestimonialCount.count,
        settings: finalSettingsCount.count
      }
    };

  } catch (error) {
    console.error("‚ùå Erro durante a migra√ß√£o:", error);
    throw new Error(`Falha na migra√ß√£o: ${error instanceof Error ? error.message : 'Erro desconhecido'}`);
  }
}

// Fun√ß√£o para resetar todas as tabelas (usar com cuidado!)
export async function resetAllTables() {
  console.log("‚ö†Ô∏è ATEN√á√ÉO: Resetando todas as tabelas...");
  
  try {
    // Deletar dados em ordem para respeitar as foreign keys
    await db.execute(sql`TRUNCATE TABLE orders RESTART IDENTITY CASCADE`);
    await db.execute(sql`TRUNCATE TABLE messages RESTART IDENTITY CASCADE`);
    await db.execute(sql`TRUNCATE TABLE contacts RESTART IDENTITY CASCADE`);
    await db.execute(sql`TRUNCATE TABLE testimonials RESTART IDENTITY CASCADE`);
    await db.execute(sql`TRUNCATE TABLE services RESTART IDENTITY CASCADE`);
    await db.execute(sql`TRUNCATE TABLE projects RESTART IDENTITY CASCADE`);
    await db.execute(sql`TRUNCATE TABLE site_settings RESTART IDENTITY CASCADE`);
    await db.execute(sql`TRUNCATE TABLE users RESTART IDENTITY CASCADE`);
    
    console.log("üóëÔ∏è Todas as tabelas foram resetadas");
    
    // Executar migra√ß√£o completa ap√≥s reset
    return await runCompleteMigration();
    
  } catch (error) {
    console.error("‚ùå Erro ao resetar tabelas:", error);
    throw new Error(`Falha no reset: ${error instanceof Error ? error.message : 'Erro desconhecido'}`);
  }
}

// Fun√ß√£o para verificar integridade dos dados
export async function checkDataIntegrity() {
  console.log("üîç Verificando integridade dos dados...");
  
  try {
    const checks = [];
    
    // Verificar se existe pelo menos um admin
    const adminResult = await db.execute(sql`SELECT COUNT(*) as count FROM users WHERE role = 'admin'`);
    const adminCount = Number((adminResult.rows[0] as any).count);
    checks.push({
      check: "Admin user exists",
      passed: adminCount > 0,
      value: adminCount
    });
    
    // Verificar se existem configura√ß√µes do site
    const [settingsExist] = await db.select({ count: count() }).from(siteSettings);
    checks.push({
      check: "Site settings exist",
      passed: settingsExist.count > 0,
      value: settingsExist.count
    });
    
    // Verificar se existem servi√ßos com pre√ßos v√°lidos
    const servicesResult = await db.execute(sql`SELECT COUNT(*) as count FROM services WHERE price > '0'`);
    const servicesCount = Number((servicesResult.rows[0] as any).count);
    checks.push({
      check: "Services with valid prices",
      passed: servicesCount > 0,
      value: servicesCount
    });
    
    // Verificar se existem projetos
    const [projectsExist] = await db.select({ count: count() }).from(projects);
    checks.push({
      check: "Projects exist",
      passed: projectsExist.count > 0,
      value: projectsExist.count
    });
    
    console.log("\nüìã Resultados da verifica√ß√£o:");
    checks.forEach(check => {
      const status = check.passed ? "‚úÖ" : "‚ùå";
      console.log(`${status} ${check.check}: ${check.value}`);
    });
    
    const allPassed = checks.every(check => check.passed);
    console.log(`\n${allPassed ? "‚úÖ" : "‚ùå"} Integridade dos dados: ${allPassed ? "OK" : "FALHOU"}`);
    
    return {
      success: allPassed,
      checks
    };
    
  } catch (error) {
    console.error("‚ùå Erro na verifica√ß√£o de integridade:", error);
    throw new Error(`Falha na verifica√ß√£o: ${error instanceof Error ? error.message : 'Erro desconhecido'}`);
  }
}